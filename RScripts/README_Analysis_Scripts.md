# Epileptogenesis Multi-Omics Analysis Pipeline

This repository contains R scripts for analyzing RNA-Seq and RRBS (methylation) data from two rat models of temporal lobe epilepsy: intrahippocampal electrical kindling (KI) and systemic kainic acid-induced status epilepticus (KA).

## Overview

The analysis pipeline consists of three main scripts:

1. **01_RNASeq_Analysis.R** - Differential gene expression analysis
2. **02_RRBS_Analysis.R** - DNA methylation analysis
3. **03_Integrative_Analysis.R** - Multi-omics integration

## Data Requirements

### Input Data Files

The scripts expect the following input data files in the `../GEOData/` directory:

#### Required Files:

1. **samples_nooutlier.txt** - Sample metadata table
   - Columns: sample, group, replicate, and other metadata
   - Groups: KI_Sham, KI_3ClassV (kindling), KA_ShamSaline, KA_3ClassV (kainic acid)

2. **comparison_250502.txt** - Comparison definitions for differential analysis
   - Columns: experiment, reference
   - Example rows:
     - `KI_3ClassV` vs `KI_Sham`
     - `KA_3ClassV` vs `KA_ShamSaline`

3. **subread_counts.csv** - Raw RNA-Seq count matrix
   - Generated by `Rsubread::featureCounts()` from aligned BAM files
   - Rows: genes, Columns: samples
   - Format: Gene symbols in first column, count values in subsequent columns

4. **fpkmDatawithMean_220205.txt** (alternative to subread_counts.csv)
   - FPKM-normalized expression values
   - Can be used if raw counts are not available

5. **beta_values.txt.gz** - Methylation beta values from RRBS
   - Processed from Bismark alignment using methylKit
   - Columns: chr, start, end, strand, followed by sample beta values (0-1 scale)
   - Rows: CpG sites genome-wide

#### Optional Files:

6. **gene.obj.rdata** - Pre-computed gene annotation object
   - Created from TxDb.Rnorvegicus.UCSC.rn6.refGene
   - Will be generated automatically if not present

7. **ensembl.gene.rdata** - Ensembl gene name mappings
   - Created using biomaRt
   - Will be generated automatically if not present

8. **GO-KEGG-annotation_250502.RData** - Functional annotation objects
   - GO and KEGG annotations for enrichment analysis
   - Will be generated automatically if not present

### Data Processing Workflow

#### RNA-Seq Data Preparation:

The pipeline expects **raw count data** from:

```r
# Option 1: Generate counts from BAM files (RECOMMENDED)
library(Rsubread)
fc_result <- featureCounts(
  files = bam_files,
  annot.ext = "rn6.refGene.gtf",
  isGTFAnnotationFile = TRUE,
  GTF.featureType = "exon",
  GTF.attrType = "gene_id",
  useMetaFeatures = TRUE
)
counts <- fc_result$counts
write.csv(counts, "subread_counts.csv")

# Option 2: Load existing count matrix
counts <- read.csv("subread_counts.csv", row.names = 1)
```

#### RRBS Data Preparation:

The pipeline uses **beta values** which represent methylation levels (0 = unmethylated, 1 = fully methylated):

```r
# Beta values are typically generated from Bismark output using:
library(methylKit)
file.list <- list.files(pattern = ".cov.gz$", full.names = TRUE)
methobj <- methRead(
  file.list,
  sample.id = sample.ids,
  assembly = "rn6",
  treatment = treatment.vector,
  context = "CpG"
)

# Extract beta values
meth <- unite(methobj, destrand = TRUE)
beta_values <- percMethylation(meth)
```

For this analysis, pre-computed beta values are loaded directly from `beta_values.txt.gz`.

## Analysis Workflow

### 1. RNA-Seq Analysis (01_RNASeq_Analysis.R)

**Input:** Raw count matrix or FPKM values

**Steps:**
1. Load count data and sample metadata
2. Quality control and PCA visualization
3. Differential expression analysis with DESeq2
4. Cross-model comparisons (4-way pairwise)
5. Overlap analysis (Venn diagrams, alluvial plots)
6. Functional enrichment (GO/KEGG)
7. Cell-type deconvolution (CIBERSORT) - optional
8. Permutation testing for overlap significance

**Output:**
- `output_RNASeq/` directory containing:
  - DEG tables for each comparison
  - PCA plots
  - Venn diagrams
  - Scatter plots
  - Enrichment results
  - Summary statistics

**Key Results:**
- Differentially expressed genes (padj < 0.05)
- Model-specific and shared DEGs
- Enriched biological pathways

### 2. RRBS Analysis (02_RRBS_Analysis.R)

**Input:** Beta values matrix (CpGs × samples)

**Steps:**
1. Load methylation beta values
2. PCA visualization
3. Load pre-computed DMCs (or calculate with methylKit)
4. Gene annotation using genomation
5. DMG aggregation (CpG-level to gene-level)
6. Genomic context analysis (promoter/exon/intron/intergenic)
7. DMR analysis (1-kb tiling windows)
8. Cross-model comparisons
9. Functional enrichment
10. Permutation testing

**Output:**
- `output_RRBS/` directory containing:
  - Annotated DMC tables
  - DMG summaries
  - Genomic context pie charts
  - Venn diagrams
  - Enrichment results

**Key Results:**
- Differentially methylated CpGs (≥25% difference, q < 0.01)
- Differentially methylated genes
- Genomic distribution of methylation changes

### 3. Integrative Analysis (03_Integrative_Analysis.R)

**Input:** Results from scripts 1 and 2

**Steps:**
1. Load DEG and DMG results
2. Within-model DEG-DMG overlaps
3. Cross-model concordant gene identification
4. Scatter plots (methylation vs expression)
5. Directional categorization:
   - Hyper-Down (hypermethylated + downregulated)
   - Hyper-Up (hypermethylated + upregulated)
   - Hypo-Down (hypomethylated + downregulated)
   - Hypo-Up (hypomethylated + upregulated)
6. CpG-site level visualization for key genes
7. Model-specific correlation analysis (Spearman)
8. Permutation testing for multi-omics overlaps

**Output:**
- `output_Integrative/` directory containing:
  - Within-model overlap results
  - Model-independent genes
  - Methylation vs expression scatter plots
  - CpG-level visualizations
  - Correlation analyses

**Key Results:**
- Genes with coordinated methylation and expression changes
- Model-independent epigenetic-transcriptomic changes
- Correlations between CpG methylation and gene expression

## Software Requirements

### R Version
- R ≥ 4.0.0

### Required R Packages

#### Core Analysis:
```r
# Data manipulation
dplyr, tidyr, data.table, stringr

# Bioconductor - Genomic analysis
BiocManager::install(c(
  "DESeq2",           # Differential expression
  "edgeR",            # Alternative DE analysis
  "methylKit",        # Methylation analysis
  "genomation",       # Genomic annotation
  "GenomicRanges",    # Genomic intervals
  "GenomicFeatures",  # Gene annotations
  "Rsubread"          # Read counting
))

# Annotations
BiocManager::install(c(
  "org.Rn.eg.db",                           # Rat annotations
  "TxDb.Rnorvegicus.UCSC.rn6.refGene",     # Rat gene models
  "biomaRt"                                 # Ensembl access
))

# Functional enrichment
install.packages("richR")  # or from GitHub
# devtools::install_github("hurlab/richR")
```

#### Visualization:
```r
install.packages(c(
  "ggplot2", "ggpubr", "pheatmap", "RColorBrewer",
  "EnhancedVolcano", "ggalluvial", "gridExtra",
  "factoextra", "ggtern"
))

BiocManager::install(c(
  "ComplexHeatmap",
  "UpSetR"
))

# VennDetail (if not on CRAN)
# devtools::install_github("hurlab/VennDetail")
```

#### Other:
```r
install.packages(c(
  "parallel",         # Parallel processing
  "openxlsx",         # Excel export
  "NMF",              # Matrix factorization
  "IOBR"              # Cell-type deconvolution (optional)
))
```

### Installation Script

```r
# Install all required packages
if (!requireNamespace("pacman", quietly = TRUE)) {
  install.packages("pacman")
}

# Use pacman to install/load all packages
pacman::p_load(
  # Core
  dplyr, tidyr, data.table, stringr,

  # Bioconductor
  BiocManager, DESeq2, edgeR, methylKit, genomation,
  GenomicRanges, GenomicFeatures, Rsubread,
  org.Rn.eg.db, TxDb.Rnorvegicus.UCSC.rn6.refGene, biomaRt,

  # Visualization
  ggplot2, ggpubr, pheatmap, RColorBrewer, EnhancedVolcano,
  ggalluvial, gridExtra, factoextra, ComplexHeatmap, UpSetR,

  # Enrichment and other
  richR, VennDetail, parallel, openxlsx, NMF
)
```

## Usage

### Running the Complete Pipeline

```bash
# 1. RNA-Seq analysis
Rscript 01_RNASeq_Analysis.R

# 2. RRBS analysis
Rscript 02_RRBS_Analysis.R

# 3. Integrative analysis
Rscript 03_Integrative_Analysis.R
```

### Running Interactively in RStudio

1. Open each script in RStudio
2. Set working directory to script location (automatic if using RStudio API)
3. Run sections sequentially or source entire script

## Output Structure

```
project_directory/
├── 01_RNASeq_Analysis.R
├── 02_RRBS_Analysis.R
├── 03_Integrative_Analysis.R
├── README_Analysis_Scripts.md
├── ../GEOData/
│   ├── samples_nooutlier.txt
│   ├── comparison_250502.txt
│   ├── subread_counts.csv
│   ├── fpkmDatawithMean_220205.txt
│   └── beta_values.txt.gz
├── output_RNASeq/
│   ├── *_DEtable_*.txt (DEG tables)
│   ├── *.pdf (visualizations)
│   └── RNASeq_Analysis_Workspace.RData
├── output_RRBS/
│   ├── *_DMCs_annotated.txt
│   ├── *_DMG_summary.txt
│   ├── *.pdf (visualizations)
│   └── RRBS_Analysis_Workspace.RData
└── output_Integrative/
    ├── *_Shared_DEG_DMG.txt
    ├── Model_Independent_Genes.txt
    ├── *_Correlations.txt
    └── Integrative_Analysis_Workspace.RData
```

## Key Parameters

### RNA-Seq Analysis:
- **padj_threshold**: 0.05 (adjusted p-value cutoff for DEGs)
- **Normalization**: DESeq2 default (median of ratios)
- **Statistical test**: Wald test

### RRBS Analysis:
- **meth_diff_threshold**: 25% (minimum methylation difference)
- **qvalue_threshold**: 0.01 (q-value cutoff for DMCs)
- **DMR window size**: 1000 bp
- **Coverage filter**: Applied in pre-processing

### Integration:
- **Correlation method**: Spearman
- **Permutation tests**: 10,000 iterations
- **FDR correction**: Benjamini-Hochberg

## Citation

If you use these scripts, please cite:

[Your Publication]
- Study: Commonalities in gene expression and methylation changes across two rat models of acquired epilepsy
- Authors: Benton Purnell*, Junguk Hur*, David Ruskin, Madhuvika Murugan, Fabio Tescarollo, Riddhimaa Sinha, Nikhil Ramavenkat, Susan Masino, Jonathan D. Geiger, and Detlev Boison
- Journal: Scientific Reports
- DOI: pending

## Data Availability

**Note:** Large data files (>100 MB) are not included in this GitHub repository. Please download them from GEO:

### Download Required Data Files:

1. **RRBS Methylation Data** (GSE287822):
   - Download `GSE287822_beta_values.txt.gz` from GEO
   - Place in `../GEOData/` directory
   - Direct link: https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE287822

2. **RNA-Seq Count Data** (GSE287823):
   - Download `GSE287823_subread_counts.csv.gz` from GEO
   - Place in `../GEOData/` directory
   - Direct link: https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE287823

3. **Sample Metadata** (included in repository):
   - `samples_nooutlier.txt` - already in repository
   - `comparison_250502.txt` - already in repository

The processed data supporting this analysis are available at:
- GEO accession: GSE287822 (RRBS data)
- GEO accession: GSE287823 (RNA-Seq data)

## Contact

For questions or issues with these scripts:
- GitHub Issues: https://github.com/hurlab/EpilepsyEpigenetics/issues
- Email: junguk.hur@med.und.edu

## License

[Specify license - e.g., MIT, GPL-3, etc.]

## Acknowledgments

- Rutgers University Genomics Center for sequencing
- This study was funded through grants NS127846 and NS065957.
- R/Bioconductor community for software tools

---

**Last Updated:** January 8, 2026
**Version:** 1.1
